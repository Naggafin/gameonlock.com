{% extends 'base.html' %}
{% load static i18n socialaccount widget_tweaks %}
{% block css %}
    {{ block.super }}
    <link rel="stylesheet"
          href="{% static 'flatpickr/css/flatpickr.min.css' %}"
          nonce="{{ request.csp_nonce }}">
{% endblock %}
{% block content %}
    <div class="sign-up">
        <div class="global-shape style-3">
            <img src="{% static 'peredion/images/shapes/shape-1.png' %}"
                 alt="{% trans 'Decorative background shape' %}"
                 data-aos="fade-left"
                 data-aos-duration="500"
                 data-aos-offset="200"
                 data-aos-easing="ease-in"
                 data-aos-delay="400"
                 nonce="{{ request.csp_nonce }}">
        </div>
        <div class="container" x-data="signupProcess($store.signupConfig)">
            <div class="row justify-content-center">
                <div class="col-xl-8 col-lg-9 col-md-11">
                    <div class="processing-steps"
                         role="navigation"
                         aria-label="{% trans 'Sign-up progress steps' %}">
                        <div class="single-steps first-step"
                             :class="{ 'current-step': currentStep >= 0 }"
                             :aria-current="currentStep >= 0 ? 'step' : null"
                             data-aos="fade-up"
                             data-aos-delay="150"
                             data-aos-duration="500"
                             data-aos-easing="ease-in">
                            <div class="part-icon">
                                <img src="{% static 'peredion/images/register/step-1.png' %}"
                                     alt="{% trans 'Step 1: Basic Info' %}"
                                     nonce="{{ request.csp_nonce }}">
                            </div>
                            <div class="part-text">
                                <span class="step-line-title">{% trans "Basic Info" %}</span>
                            </div>
                        </div>
                        <div class="arrow-img"
                             :class="{ 'current-arrow': currentStep >= 1 }"
                             data-aos="fade-right"
                             data-aos-delay="150"
                             data-aos-duration="500"
                             data-aos-easing="ease-in">
                            <img src="{% static 'peredion/images/register/arrow-1.png' %}"
                                 alt="{% trans 'Progress arrow between steps 1 and 2' %}"
                                 class="arrow-icon"
                                 nonce="{{ request.csp_nonce }}">
                        </div>
                        <div class="single-steps second-step"
                             :class="{ 'current-step': currentStep >= 1 }"
                             :aria-current="currentStep >= 1 ? 'step' : null"
                             data-aos="fade-up"
                             data-aos-delay="200"
                             data-aos-duration="500"
                             data-aos-easing="ease-in">
                            <div class="part-icon">
                                <img src="{% static 'peredion/images/register/step-2.png' %}"
                                     alt="{% trans 'Step 2: Personal Details' %}"
                                     nonce="{{ request.csp_nonce }}">
                            </div>
                            <div class="part-text">
                                <span class="step-line-title">{% trans "Personal Details" %}</span>
                            </div>
                        </div>
                        <div class="arrow-img second"
                             :class="{ 'current-arrow': currentStep >= 2 }"
                             data-aos="fade-right"
                             data-aos-delay="200"
                             data-aos-duration="500"
                             data-aos-easing="ease-in">
                            <img src="{% static 'peredion/images/register/arrow-2.png' %}"
                                 alt="{% trans 'Progress arrow between steps 2 and 3' %}"
                                 class="arrow-icon"
                                 nonce="{{ request.csp_nonce }}">
                        </div>
                        <div class="single-steps third-step"
                             :class="{ 'current-step': currentStep >= 2 }"
                             :aria-current="currentStep >= 2 ? 'step' : null"
                             data-aos="fade-up"
                             data-aos-delay="250"
                             data-aos-duration="500"
                             data-aos-easing="ease-in">
                            <div class="part-icon">
                                <img src="{% static 'peredion/images/register/step-3.png' %}"
                                     alt="{% trans 'Step 3: Contact Info' %}"
                                     nonce="{{ request.csp_nonce }}">
                            </div>
                            <div class="part-text">
                                <span class="step-line-title">{% trans "Contact Info" %}</span>
                            </div>
                        </div>
                        <div class="arrow-img"
                             :class="{ 'current-arrow': currentStep >= 3 }"
                             data-aos="fade-right"
                             data-aos-delay="250"
                             data-aos-duration="500"
                             data-aos-easing="ease-in">
                            <img src="{% static 'peredion/images/register/arrow-1.png' %}"
                                 alt="{% trans 'Progress arrow between steps 3 and 4' %}"
                                 class="arrow-icon"
                                 nonce="{{ request.csp_nonce }}">
                        </div>
                        <div class="single-steps last-step"
                             :class="{ 'current-step': currentStep >= 3 }"
                             :aria-current="currentStep >= 3 ? 'step' : null"
                             data-aos="fade-up"
                             data-aos-delay="300"
                             data-aos-duration="500"
                             data-aos-easing="ease-in">
                            <div class="part-icon">
                                <img src="{% static 'peredion/images/register/step-4.png' %}"
                                     alt="{% trans 'Step 4: Security & Confirmation' %}"
                                     nonce="{{ request.csp_nonce }}">
                            </div>
                            <div class="part-text">
                                <span class="step-line-title">{% trans "Security & Confirmation" %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-xl-10 col-lg-10"
                     data-aos="fade-up"
                     data-aos-delay="100"
                     data-aos-duration="500"
                     data-aos-easing="ease-in">
                    <div class="poklotto-form"
                         id="poklotto_register_form"
                         role="form"
                         x-ref="form"
                         aria-label="{% trans 'Sign-up form' %}">
                        <h3 class="steps-heading-title title" x-text="steps[currentStep].title"></h3>
                        <div class="part-form">
                            <form method="post"
                                  action="{% url 'account_signup' %}"
                                  :class="{ 'was-validated': submitted }"
                                  @submit.prevent="submitForm">
                                {% csrf_token %}
                                <div x-show="form.errors.length"
                                     class="alert alert-danger"
                                     role="alert"
                                     aria-live="polite">
                                    <div x-text="form.errors.join(', ')"></div>
                                </div>
                                <div class="form-all-step">
                                    <!-- Step 1: Basic Info -->
                                    <div class="first-step-form per-step animate__animated active"
                                         :class="{ 'animate__fadeInRight': currentStep === 0 }"
                                         x-show="currentStep === 0"
                                         x-transition>
                                        <div class="row">
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.username.id_for_label|add:"-error" %}
                                                    <label for="{{ form.username.id_for_label }}" class="form-label">
                                                        <span>{{ form.username.label }}</span>
                                                    </label>
                                                    {% render_field form.username ::class="{'is-invalid':form.username.errors.length}" x-model="form.username.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.username.errors.length"
                                                         x-text="form.username.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.email.id_for_label|add:"-error" %}
                                                    <label for="{{ form.email.id_for_label }}" class="form-label">
                                                        <span>{{ form.email.label }}</span>
                                                    </label>
                                                    {% render_field form.email ::class="{'is-invalid':form.email.errors.length}" x-model="form.email.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.email.errors.length"
                                                         x-text="form.email.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step 2: Personal Details -->
                                    <div class="second-step-form per-step animate__animated"
                                         :class="{ 'animate__fadeInRight': currentStep === 1 }"
                                         x-show="currentStep === 1"
                                         x-transition>
                                        <div class="row">
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.first_name.id_for_label|add:"-error" %}
                                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                                        <span>{{ form.first_name.label }}</span>
                                                    </label>
                                                    {% render_field form.first_name ::class="{'is-invalid':form.first_name.errors.length}" x-model="form.first_name.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.first_name.errors.length"
                                                         x-text="form.first_name.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.last_name.id_for_label|add:"-error" %}
                                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                                        <span>{{ form.last_name.label }}</span>
                                                    </label>
                                                    {% render_field form.last_name ::class="{'is-invalid':form.last_name.errors.length}" x-model="form.last_name.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.last_name.errors.length"
                                                         x-text="form.last_name.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.country.id_for_label|add:"-error" %}
                                                    <label for="{{ form.country.id_for_label }}" class="form-label">
                                                        <span>{{ form.country.label }}</span>
                                                    </label>
                                                    {% render_field form.country @change="updateRegions" ::class="{'is-invalid':form.country.errors.length}" x-model="form.country.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.country.errors.length"
                                                         x-text="form.country.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3"
                                                 x-show="form.region.choices.length"
                                                 x-transition>
                                                {% with error_label=form.region.id_for_label|add:"-error" %}
                                                    <label for="{{ form.region.id_for_label }}" class="form-label">
                                                        <span>{{ form.region.label }}</span>
                                                    </label>
                                                    <select id="{{ form.region.id_for_label }}"
                                                            name="{{ form.region.html_name }}"
                                                            class="m-0"
                                                            :class="{'is-invalid':form.region.errors.length}"
                                                            x-model="form.region.value"
                                                            aria-describedby="error_label">
                                                        <option value="">{% trans "Select Region" %}</option>
                                                        <template x-for="region in form.region.choices" :key="region[0]">
                                                            <option :value="region[0]" x-text="region[1]"></option>
                                                        </template>
                                                    </select>
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.region.errors.length"
                                                         x-text="form.region.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.date_of_birth.id_for_label|add:"-error" %}
                                                    <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                                        <span>{{ form.date_of_birth.label }}</span>
                                                    </label>
                                                    <div class="birth-date-element">
                                                        {% render_field form.date_of_birth @change="checkAge" ::class="{'is-invalid':form.date_of_birth.errors.length}" x-model="form.date_of_birth.value" x-init="flatpickr($el, { onChange: ([date]) => { form.date_of_birth.value = $el.value; checkAge(); } })" class="m-0" aria-describedby=error_label %}
                                                        <span class="caln-icon" aria-hidden="true">
                                                            <i class="fa-solid fa-calendar-days"></i>
                                                        </span>
                                                    </div>
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.date_of_birth.errors.length"
                                                         x-text="form.date_of_birth.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step 3: Contact Info -->
                                    <div class="third-step-form per-step animate__animated"
                                         :class="{ 'animate__fadeInRight': currentStep === 2 }"
                                         x-show="currentStep === 2"
                                         x-transition>
                                        <div class="row">
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.phone_number.id_for_label|add:"-error" %}
                                                    <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                                        <span>{{ form.phone_number.label }} {% trans "(Optional)" %}</span>
                                                    </label>
                                                    {% render_field form.phone_number ::class="{'is-invalid':form.phone_number.errors.length}" x-model="form.phone_number.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.phone_number.errors.length"
                                                         x-text="form.phone_number.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.alternate_email_address.id_for_label|add:"-error" %}
                                                    <label for="{{ form.alternate_email_address.id_for_label }}"
                                                           class="form-label">
                                                        <span>{{ form.alternate_email_address.label }} {% trans "(Optional)" %}</span>
                                                    </label>
                                                    {% render_field form.alternate_email_address ::class="{'is-invalid':form.alternate_email_address.errors.length}" x-model="form.alternate_email_address.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.alternate_email_address.errors.length"
                                                         x-text="form.alternate_email_address.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step 4: Security & Confirmation -->
                                    <div class="fourth-step-form per-step animate__animated"
                                         :class="{ 'animate__fadeInRight': currentStep === 3 }"
                                         x-show="currentStep === 3"
                                         x-transition>
                                        <div class="row">
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.password1.id_for_label|add:"-error" %}
                                                    <label for="{{ form.password1.id_for_label }}" class="form-label">
                                                        <span>{{ form.password1.label }}</span>
                                                    </label>
                                                    {% render_field form.password1 @input="checkPasswordMatch" ::class="{'is-invalid':form.password1.errors.length}" x-model="form.password1.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.password1.errors.length"
                                                         x-text="form.password1.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-6 col-lg-6 col-md-6 mb-3">
                                                {% with error_label=form.password2.id_for_label|add:"-error" %}
                                                    <label for="{{ form.password2.id_for_label }}" class="form-label">
                                                        <span>{{ form.password2.label }}</span>
                                                    </label>
                                                    {% render_field form.password2 @input="checkPasswordMatch" ::class="{'is-invalid':form.password2.errors.length}" x-model="form.password2.value" class="m-0" aria-describedby=error_label %}
                                                    <div id="{{ error_label }}"
                                                         class="invalid-feedback"
                                                         x-show="form.password2.errors.length"
                                                         x-text="form.password2.errors.join(', ')"
                                                         aria-live="polite"></div>
                                                {% endwith %}
                                            </div>
                                            <div class="col-xl-12">
                                                <div class="agreement-article">
                                                    <div class="form-check form-check-inline mb-3">
                                                        {% with error_label=form.terms.id_for_label|add:"-error" %}
                                                            {% render_field form.terms ::class="{'is-invalid':form.terms.errors.length}" class="form-check-input" x-model="form.terms.value" class="m-0" aria-describedby=error_label %}
                                                            <label for="{{ form.terms.id_for_label }}">
                                                                <span>{{ form.terms.label|safe }}</span>
                                                            </label>
                                                            <div id="{{ error_label }}"
                                                                 class="invalid-feedback"
                                                                 x-show="form.terms.errors.length"
                                                                 x-text="form.terms.errors.join(', ')"
                                                                 aria-live="polite"></div>
                                                        {% endwith %}
                                                    </div>
                                                    <div class="form-check form-check-inline mb-3">
                                                        {% with error_label=form.age.id_for_label|add:"-error" %}
                                                            {% render_field form.age ::class="{'is-invalid':form.age.errors.length}" class="form-check-input" x-model="form.age.value" class="m-0" aria-describedby=error_label %}
                                                            <label for="{{ form.age.id_for_label }}">
                                                                <span>{{ form.age.label }}</span>
                                                            </label>
                                                            <div id="{{ error_label }}"
                                                                 class="invalid-feedback"
                                                                 x-show="form.age.errors.length"
                                                                 x-text="form.age.errors.join(', ')"
                                                                 aria-live="polite"></div>
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-controller mt-5">
                                    <button class="prv-stp-btn"
                                            @click="prevStep"
                                            type="button"
                                            x-show="currentStep > 0"
                                            aria-label="{% trans 'Previous Step' %}">
                                        <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
                                    </button>
                                    <button class="prd-btn-1"
                                            @click="nextStep"
                                            type="button"
                                            x-show="currentStep < 3"
                                            aria-label="{% trans 'Next Step' %}">
                                        {% trans "Next Step" %} <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                                    </button>
                                    <button class="prd-btn-1"
                                            type="submit"
                                            x-show="currentStep === 3"
                                            aria-label="{% trans 'Sign Up' %}">
                                        {% trans "Sign Up" %} <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </form>
                            <div class="part-connect-social-info">
                                <div class="title-overlap">
                                    <h4 class="title">{% trans "Or Sign Up With" %}</h4>
                                </div>
                                <ul>
                                    <li>
                                        <a href="{% provider_login_url 'google' %}"
                                           class="single-social s-pinterest"
                                           aria-label="{% trans 'Sign up with Google' %}">
                                            <i class="fa-brands fa-google" aria-hidden="true"></i>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% provider_login_url 'facebook' %}"
                                           class="single-social s-facebook"
                                           aria-label="{% trans 'Sign up with Facebook' %}">
                                            <i class="fa-brands fa-facebook-f" aria-hidden="true"></i>
                                        </a>
                                    </li>
                                    {% comment %}
                                    <li>
                                        <a href="{% provider_login_url 'twitter' %}" class="single-social s-twitter" aria-label="{% trans 'Sign up with Twitter' %}">
                                            <i class="fa-brands fa-twitter" aria-hidden="true"></i>
                                        </a>
                                    </li>
                                    {% endcomment %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    {{ block.super }}
    <script src="{% static 'flatpickr/js/flatpickr.js' %}"
            nonce="{{ request.csp_nonce }}"
            defer></script>
    {{ signup_config|json_script:"signup-config" }}
    <script nonce="{{ request.csp_nonce }}">
        document.addEventListener('alpine:init', () => {
            Alpine.store('signupConfig', {
                signupUrl: '/accounts/signup/',
                regions: {},
                form: {
                    username: {
                        value: '',
                        errors: []
                    },
                    email: {
                        value: '',
                        errors: []
                    },
                    first_name: {
                        value: '',
                        errors: []
                    },
                    last_name: {
                        value: '',
                        errors: []
                    },
                    country: {
                        value: 'US',
                        errors: []
                    },
                    region: {
                        value: '',
                        choices: [],
                        errors: []
                    },
                    date_of_birth: {
                        value: '',
                        errors: []
                    },
                    phone_number: {
                        value: '',
                        errors: []
                    },
                    alternate_email_address: {
                        value: '',
                        errors: []
                    },
                    password1: {
                        value: '',
                        errors: []
                    },
                    password2: {
                        value: '',
                        errors: []
                    },
                    terms: {
                        value: false,
                        errors: []
                    },
                    age: {
                        value: false,
                        errors: []
                    },
                    errors: []
                },

                init() {
                    try {
                        const config = JSON.parse(document.getElementById('signup-config').innerHTML || '{}');
                        this.signupUrl = config.SIGNUP_URL || this.signupUrl;
                        this.regions = config.REGIONS || {};
                        this.form = {
                            username: {
                                value: config.FORM.username.value || '',
                                errors: config.FORM.username.errors || []
                            },
                            email: {
                                value: config.FORM.email.value || '',
                                errors: config.FORM.email.errors || []
                            },
                            first_name: {
                                value: config.FORM.first_name.value || '',
                                errors: config.FORM.first_name.errors || []
                            },
                            last_name: {
                                value: config.FORM.last_name.value || '',
                                errors: config.FORM.last_name.errors || []
                            },
                            country: {
                                value: config.FORM.country.value || 'US',
                                errors: config.FORM.country.errors || []
                            },
                            region: {
                                value: config.FORM.region.value || '',
                                choices: config.REGIONS?.[config.FORM.country.value || 'US'] || [
                                    ['', gettext('Select Region')]
                                ],
                                errors: config.FORM.region.errors || []
                            },
                            date_of_birth: {
                                value: config.FORM.date_of_birth.value || '',
                                errors: config.FORM.date_of_birth.errors || []
                            },
                            phone_number: {
                                value: config.FORM.phone_number.value || '',
                                errors: config.FORM.phone_number.errors || []
                            },
                            alternate_email_address: {
                                value: config.FORM.alternate_email_address.value || '',
                                errors: config.FORM.alternate_email_address.errors || []
                            },
                            password1: {
                                value: '',
                                errors: config.FORM.password1.errors || []
                            },
                            password2: {
                                value: '',
                                errors: config.FORM.password2.errors || []
                            },
                            terms: {
                                value: false,
                                errors: config.FORM?.terms?.errors || []
                            },
                            age: {
                                value: false,
                                errors: config.FORM?.age?.errors || []
                            },
                            errors: config.FORM.errors || []
                        };
                    } catch (error) {
                        console.error('Failed to load registration config:', error);
                        Alpine.store('alerts').add({
                            message: gettext('Error loading registration form configuration.'),
                            type: 'danger'
                        });
                    }
                }
            });

            // Register signupProcess component
            Alpine.data('signupProcess', (config) => ({
                currentStep: 0,
                submitted: false,
                form: {
                    ...config.form
                },
                steps: [{
                    title: gettext("Basic Info")
                }, {
                    title: gettext("Personal Details")
                }, {
                    title: gettext("Contact Info")
                }, {
                    title: gettext("Security & Confirmation")
                }],
                canProceed: true,
                canSubmit: false,
                config: config,

                init() {
                    try {
                        if (!window.flatpickr) {
                            console.error('Flatpickr not loaded.');
                            Alpine.store('alerts').add({
                                message: gettext('Date picker unavailable. Please try again.'),
                                type: 'danger'
                            });
                        }
                    } catch (error) {
                        console.error('Registration init error:', error);
                        Alpine.store('alerts').add({
                            message: gettext('Error initializing registration form.'),
                            type: 'danger'
                        });
                    }
                },

                nextStep() {
                    this.validateStep();
                    if (this.currentStep < 3 && this.canProceed) {
                        this.currentStep++;
                        this.scrollToForm();
                    }
                },

                prevStep() {
                    this.validateStep();
                    if (this.currentStep > 0) {
                        this.currentStep--;
                        this.scrollToForm();
                    }
                },

                scrollToForm() {
                    const el = this.$refs.form;
                    if (!el) return;
                    const rect = el.getBoundingClientRect();
                    const isVisible = (
                        rect.top >= 0 &&
                        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight)
                    );
                    if (!isVisible) {
                        el.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                },

                updateRegions() {
                    this.form.region.choices = this.config.regions[this.form.country.value] || [
                        ['', gettext('Select Region')]
                    ];
                    this.form.region.value = '';
                },

                checkAge() {
                    if (this.form.date_of_birth.value) {
                        const dob = new Date(this.form.date_of_birth.value);
                        const today = new Date();
                        let age = today.getFullYear() - dob.getFullYear();
                        const m = today.getMonth() - dob.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
                        this.form.date_of_birth.errors = (age < 18) ? [gettext('You must be at least 18 years old to register.')] : [];
                    } else {
                        this.form.date_of_birth.errors = [gettext('Date of Birth is required.')];
                    }
                },

                checkPasswordMatch() {
                    if (this.form.password1.value && this.form.password2.value) {
                        this.form.password2.errors = (this.form.password1.value !== this.form.password2.value) ? [gettext('Passwords do not match.')] :
                            this.form.password2.value ? [] : [gettext('Confirm Password is required.')];
                    }
                },

                validateStep() {
                    this.form.errors = this.form.errors.filter(error => !error.includes(gettext('Please complete all required fields')));
                    if (this.currentStep === 0) {
                        this.form.username.errors = this.form.username.value ? [] : [gettext('Username is required.')];
                        this.form.email.errors = this.form.email.value ? [] : [gettext('Email is required.')];
                        this.canProceed = this.form.username.errors.length === 0 && this.form.email.errors.length === 0;
                    } else if (this.currentStep === 1) {
                        this.form.first_name.errors = this.form.first_name.value ? [] : [gettext('First Name is required.')];
                        this.form.last_name.errors = this.form.last_name.value ? [] : [gettext('Last Name is required.')];
                        this.form.country.errors = this.form.country.value ? [] : [gettext('Country is required.')];
                        this.form.region.errors = this.form.region.value ? [] : [gettext('Region is required.')];
                        this.checkAge();
                        this.canProceed = this.form.first_name.errors.length === 0 &&
                            this.form.last_name.errors.length === 0 &&
                            this.form.country.errors.length === 0 &&
                            this.form.region.errors.length === 0 &&
                            this.form.date_of_birth.errors.length === 0;
                    } else if (this.currentStep === 2) {
                        this.canProceed = true;
                    } else if (this.currentStep === 3) {
                        this.form.password1.errors = this.form.password1.value ? [] : [gettext('Password is required.')];
                        this.checkPasswordMatch();
                        this.form.terms.errors = this.form.terms.value ? [] : [gettext('You must agree to the terms and conditions.')];
                        this.form.age.errors = this.form.age.value ? [] : [gettext('You must confirm you are at least 18 years old.')];
                        this.canProceed = this.form.password1.errors.length === 0 &&
                            this.form.password2.errors.length === 0 &&
                            this.form.terms.errors.length === 0 &&
                            this.form.age.errors.length === 0;
                        this.canSubmit = this.canProceed;
                    }

                    if (!this.canProceed) {
                        Alpine.store('alerts').add({
                            message: gettext('Please complete all required fields.'),
                            type: 'danger'
                        });
                    }
                },

                submitForm(event) {
                    this.submitted = true;
                    this.validateStep();
                    if (this.canSubmit) {
                        event.target.submit();
                    } else {
                        this.form.errors = [gettext('Please complete all required fields and confirm terms and age.')];
                        if (this.form.password1.value !== this.form.password2.value) {
                            this.form.errors.push(gettext('Passwords do not match.'));
                        }
                        Alpine.store('alerts').add({
                            message: gettext('Form submission failed. Please check errors.'),
                            type: 'danger'
                        });
                    }
                }
            }));
        });
    </script>
{% endblock %}
