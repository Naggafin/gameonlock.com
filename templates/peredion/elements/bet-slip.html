{% load static i18n %}
{% load sportsbetting_tags %}
<div class="bet-slip" x-data="betSlip" x-cloak>
    <!-- Header -->
    <button class="bet-slip-header"
            @click="toggle"
            type="button"
            :aria-expanded="isOpen"
            aria-controls="bet-slip-body">
        <span class="icon"><i class="fa-solid fa-clipboard-list"></i></span>
        <span class="text">{% trans 'Bet Slip' %}</span>
        <span class="slip-quantity-badge" x-text="store.picks.length"></span>
    </button>
    <!-- Body -->
    <div class="bet-slip-body"
         id="bet-slip-body"
         x-show="isOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform translate-y-4"
         @click.outside="isOpen = false">
        <div class="part-slip-header">
            <div class="all-bs-card">
                <!-- Empty State -->
                <div class="empty-card" x-show="store.picks.length === 0 && !submitted">
                    <img src="{% static 'peredion/images/playing-bet/bet-slip/empty-icon.png' %}"
                         alt=""
                         nonce="{{ request.csp_nonce }}">
                    <h4 class="empty-title">{% trans 'Your bet slip is empty!' %}</h4>
                    <p>{% trans "Looks like you haven't placed a bet yet." %}</p>
                </div>
                <!-- Success State -->
                <div class="successful-card" x-show="submitted" x-transition>
                    <svg version="1.1"
                         xmlns="http://www.w3.org/2000/svg"
                         viewBox="0 0 130.2 130.2"
                         style="display: inline-block">
                        <circle class="path circle" fill="none" stroke="#73AF55" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1"></circle>
                        <polyline class="path check" fill="none" stroke="#73AF55" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" points="100.2,40.2 51.5,88.8 29.8,67.5 "></polyline>
                    </svg>
                    <h4 class="empty-title">{% trans 'Bet placed successfully!' %}</h4>
                    <p>{% trans 'Check your bets in the dashboard.' %}</p>
                </div>
                <!-- Bet Cards -->
                <template x-for="(pick, index) in store.picks"
                          :key="`${pick.bettingLine}::${pick.type}`">
                    <div class="single-bs-card singleBS" x-show="!submitted">
                        <div class="bs-card-header">
                            <span class="tournament-name" x-text="displayTournament(pick)"></span>
                            <div class="slct-place">
                                <span class="team-name" x-text="displayPick(pick)"></span>
                            </div>
                            <button class="slip-dlt" @click="store.removePick(pick)">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                        <div class="slct-match">
                            <span class="sports-category-icon">
                                <img src="{% static 'peredion/images/playing-bet/bet-slip/sports-icon.png' %}"
                                     alt=""
                                     nonce="{{ request.csp_nonce }}">
                            </span>
                            <span class="team-1" x-text="pick.game.away_team"></span>
                            {% trans 'vs' %}
                            <span class="team-2" x-text="pick.game.home_team"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        <!-- Calculation and Submission -->
        <div class="bet-slip-calculation"
             x-show="store.picks.length > 0 && !submitted">
            <div class="total-calc">
                <div class="single-calc">
                    <span class="text">{% trans 'Total stake:' %}</span>
                    <input type="number"
                           x-model="store.amount"
                           :min="config.minBet"
                           step="0.01"
                           class="form-control d-inline w-auto"
                           @change="store.saveBetSlip">
                </div>
                <div class="single-calc">
                    <span class="text">{% trans 'Total est. return:' %}</span>
                    <span class="number total-est-return" x-text="calculateReturn"></span>
                </div>
            </div>
            <div class="calc-finish">
                {% if request.user.is_authenticated %}
                    <button class="prd-btn-1 medium"
                            @click="submitBet"
                            :disabled="store.amount < config.minBet || store.picks.length < config.minNumBets">
                        <span x-text="store.amount < config.minBet ? `{% trans 'Must bet at least' %} $${config.minBet.toFixed(2)}` : (store.picks.length < config.minNumBets ? `{% trans 'Must place at least' %} ${config.minNumBets} {% trans 'bets' %}` : '{% trans 'Place Bets' %}')"></span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                {% else %}
                    <a :href="loginUrl" class="prd-btn-1 medium">
                        {% trans 'Log In To Place Bets' %} <i class="fa-solid fa-arrow-right"></i>
                    </a>
                {% endif %}
                <button class="calc-dlt" @click="store.clearBetSlip">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{{ bet_slip_config|json_script:"bet-slip-config" }}
<script nonce="{{ request.csp_nonce }}">
    document.addEventListener('alpine:init', () => {
        Alpine.store('betSlip', {
            picks: [],
            amount: 0,
            config: {},

            init() {
                try {
                    this.config = JSON.parse(document.getElementById('bet-slip-config').innerHTML);
                } catch (error) {
                    console.error('Failed to load bet slip config:', error);
                }

                const betSlip = this.loadBetSlip();
                this.picks = betSlip.picks;
                this.amount = betSlip.amount;
            },

            loadBetSlip() {
                const _default = {
                    picks: [],
                    amount: 0
                };
                try {
                    return JSON.parse(localStorage.getItem('betslip')) || _default;
                } catch (error) {
                    console.error('Failed to load bet slip:', error);
                    return _default;
                }
            },

            saveBetSlip() {
                try {
                    if (this.picks.length > 0) this.amount = Math.max(this.amount, this.config.minBet);
                    localStorage.setItem('betslip', JSON.stringify({
                        picks: this.picks,
                        amount: this.amount
                    }));
                    window.dispatchEvent(new Event('betSlipUpdated'));
                } catch (error) {
                    console.error('Failed to save bet slip:', error);
                }
            },

            clearBetSlip() {
                this.picks = [];
                this.amount = 0;
                this.saveBetSlip();
            },

            addPick(pick) {
                this.picks = this.picks.filter(p => !(p.bettingLine === pick.bettingLine && p.type === pick.type));
                this.picks.push(pick);
                this.saveBetSlip();
            },

            removePick(pick) {
                this.picks = this.picks.filter(p => !(p.bettingLine === pick.bettingLine && p.type === pick.type));
                this.saveBetSlip();
            }
        });

        Alpine.data('betSlip', () => ({
            store: {},
            config: {},
            isOpen: false,
            submitted: false,

            init() {
                this.store = Alpine.store('betSlip');
                this.config = this.store.config;
            },

            toggle() {
                this.isOpen = !this.isOpen;
            },

            displayTournament(pick) {
                return 'TODO';
            },

            displayPick(pick) {
                if (pick.type === 'sp') {
                    return `${pick.team || gettext('N/A')} ${gettext('Spread')}`;
                } else if (pick.type === 'uo') {
                    return pick.isOver ? gettext('Over') : gettext('Under');
                }
                return gettext('Unknown Pick');
            },

            calculateReturn() {
                const store = this.store;
                const config = this.config;
                const multiplier = Math.floor(
                    config.baseBetStakes +
                    ((store.picks.length - config.minNumBets) / config.betStep) * config.betMultiplier
                );
                return Math.max(store.amount * multiplier, 0).toFixed(2);
            },

            async submitBet() {
                const store = this.store;
                const config = this.config;

                if (store.amount < config.minBet || store.picks.length < config.minNumBets) {
                    Alpine.store('alerts').add({
                        message: gettext('Validation failed: Minimum bet or picks not met.'),
                        type: 'danger'
                    });
                    return;
                }

                const payload = {
                    amount: this.calculateReturn(),
                    picks: store.picks
                };

                try {
                    const response = await fetch(config.submitUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': config.csrfToken
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        this.submitted = true;
                        store.clearBetSlip();
                        Alpine.store('alerts').add({
                            message: gettext('Bet placed successfully!'),
                            type: 'success'
                        });
                        setTimeout(() => {
                            store.submitted = false;
                        }, 2000);
                    } else {
                        Alpine.store('alerts').add({
                            message: gettext('Bet submission failed: ') + (result.error || gettext('Unknown error')),
                            type: 'danger'
                        });
                    }
                } catch (e) {
                    console.error('Error submitting bet:', e);
                    Alpine.store('alerts').add({
                        message: gettext('Error submitting bet: ') + e.message,
                        type: 'danger'
                    });
                }
            }
        }));
    });
</script>
