{% load static i18n %}
{% load sportsbetting_tags %}
<div class="bet-slip"
     x-data="betSlip($store.betSlipConfig)"
     x-init="init()"
     x-cloak>
    <!-- Header -->
    <button class="bet-slip-header"
            @click="toggle()"
            type="button"
            :aria-expanded="isOpen"
            aria-controls="bet-slip-body">
        <span class="icon"><i class="fa-solid fa-clipboard-list"></i></span>
        <span class="text">{% trans 'Bet Slip' %}</span>
        <span class="slip-quantity-badge" x-text="picks.length"></span>
    </button>
    <!-- Body -->
    <div class="bet-slip-body"
         id="bet-slip-body"
         x-show="isOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform translate-y-4"
         @click.outside="isOpen = false">
        <div class="part-slip-header">
            <div class="all-bs-card">
                <!-- Empty State -->
                <div class="empty-card" x-show="picks.length === 0 && !submitted">
                    <img src="{% static 'peredion/images/playing-bet/bet-slip/empty-icon.png' %}"
                         alt=""
                         nonce="{{ request.csp_nonce }}">
                    <h4 class="empty-title">{% trans 'Your bet slip is empty!' %}</h4>
                    <p>{% trans "Looks like you haven't placed a bet yet." %}</p>
                </div>
                <!-- Success State -->
                <div class="successful-card" x-show="submitted" x-transition>
                    <svg version="1.1"
                         xmlns="http://www.w3.org/2000/svg"
                         viewBox="0 0 130.2 130.2"
                         style="display: inline-block">
                        <circle class="path circle" fill="none" stroke="#73AF55" stroke-width="6" stroke-miterlimit="10" cx="65.1" cy="65.1" r="62.1"></circle>
                        <polyline class="path check" fill="none" stroke="#73AF55" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" points="100.2,40.2 51.5,88.8 29.8,67.5 "></polyline>
                    </svg>
                    <h4 class="empty-title">{% trans 'Bet placed successfully!' %}</h4>
                    <p>{% trans 'Check your bets in the dashboard.' %}</p>
                </div>
                <!-- Bet Cards -->
                <template x-for="(pick, index) in picks" :key="pick.betting_line">
                    <div class="single-bs-card singleBS" x-show="!submitted">
                        <div class="bs-card-header">
                            <span class="tournament-name" x-text="pick.game_data.league"></span>
                            <div class="slct-place">
                                <span class="team-name" x-text="displayPick(pick)"></span>
                            </div>
                            <button class="slip-dlt" @click="removePick(index)">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                        <div class="slct-match">
                            <span class="sports-category-icon">
                                <img src="{% static 'peredion/images/playing-bet/bet-slip/sports-icon.png' %}"
                                     alt=""
                                     nonce="{{ request.csp_nonce }}">
                            </span>
                            <span class="team-1" x-text="pick.game_data.away_team"></span>
                            {% trans 'vs' %}
                            <span class="team-2" x-text="pick.game_data.home_team"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        <!-- Calculation and Submission -->
        <div class="bet-slip-calculation" x-show="picks.length > 0 && !submitted">
            <div class="total-calc">
                <div class="single-calc">
                    <span class="text">{% trans 'Total stake:' %}</span>
                    <input type="number"
                           x-model="amount"
                           :min="minBet"
                           step="0.01"
                           class="form-control d-inline w-auto"
                           @change="saveAmount()">
                </div>
                <div class="single-calc">
                    <span class="text">{% trans 'Total est. return:' %}</span>
                    <span class="number total-est-return" x-text="calculateReturn()"></span>
                </div>
            </div>
            <div class="calc-finish">
                {% if request.user.is_authenticated %}
                    <button class="prd-btn-1 medium"
                            @click="submitBet()"
                            :disabled="amount < minBet || picks.length < minNumBets">
                        <span x-text="amount < minBet ? `{% trans 'Must bet at least' %} $${minBet.toFixed(2)}` : (picks.length < minNumBets ? `{% trans 'Must place at least' %} ${minNumBets} {% trans 'bets' %}` : '{% trans 'Place Bets' %}')"></span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                {% else %}
                    <a :href="loginUrl" class="prd-btn-1 medium">
                        {% trans 'Log In To Place Bets' %} <i class="fa-solid fa-arrow-right"></i>
                    </a>
                {% endif %}
                <button class="calc-dlt" @click="clearSlip()">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{{ bet_slip_config|json_script:"bet-slip-config" }}
<script nonce="{{ request.csp_nonce }}">
    document.addEventListener('alpine:init', () => {
        // Register betSlipConfig store
        Alpine.store('betSlipConfig', {
            minBet: 0,
            baseBetStakes: 0,
            minNumBets: 0,
            betStep: 0,
            betMultiplier: 0,
            loginUrl: '',
            submitUrl: '',
            csrfToken: '',
            isAuthenticated: false,

            init() {
                try {
                    const config = JSON.parse(document.getElementById('bet-slip-config')?.innerHTML || '{}');
                    this.minBet = config.MIN_BET || 0;
                    this.baseBetStakes = config.BASE_BET_STAKES || 0;
                    this.minNumBets = config.MIN_NUM_BETS || 0;
                    this.betStep = config.BET_STEP || 0;
                    this.betMultiplier = config.BET_MULTIPLIER || 0;
                    this.loginUrl = config.LOGIN_URL || '/accounts/login/';
                    this.submitUrl = config.SUBMIT_URL || '/sportsbetting/play/create/';
                    this.csrfToken = config.CSRF_TOKEN || '';
                    this.isAuthenticated = config.IS_AUTHENTICATED || false;
                } catch (error) {
                    console.error('Failed to load bet slip config:', error);
                }
            }
        });

        // Register betSlip store for picks
        Alpine.store('betSlip', {
            picks: [],

            init() {
                this.picks = this.loadPicks();
            },

            loadPicks() {
                try {
                    const slip = JSON.parse(localStorage.getItem('betslip') || '{"picks":[],"amount":' + (Alpine.store('betSlipConfig').minBet || 0) + '}');
                    return (slip.picks || []).map(pick => ({
                        ...pick,
                        game_data: pick.game_data || {},
                        betting_line: pick.betting_line || '',
                        type: pick.type || '',
                        team: pick.team || null,
                        is_over: pick.is_over !== undefined ? pick.is_over : null,
                        game: pick.game || null
                    }));
                } catch (error) {
                    console.error('Failed to load bet slip:', error);
                    return [];
                }
            },

            savePicks(picks, amount) {
                try {
                    localStorage.setItem('betslip', JSON.stringify({
                        picks: picks,
                        amount: amount || Alpine.store('betSlipConfig').minBet
                    }));
                    window.dispatchEvent(new Event('betslip-updated'));
                } catch (error) {
                    console.error('Failed to save bet slip:', error);
                }
            },

            addPick(bettingLine, type, team, isOver, gameData) {
                if (!bettingLine || !type) {
                    console.error('Invalid pick data: missing betting line or type', {
                        bettingLine,
                        type
                    });
                    return;
                }
                gameData = gameData || {};
                const pick = {
                    betting_line: bettingLine,
                    type: type,
                    team: team || null,
                    is_over: isOver !== undefined ? isOver : null,
                    game: gameData.game || null,
                    game_data: gameData
                };
                this.picks = this.picks.filter(p => p.betting_line !== bettingLine);
                this.picks.push(pick);
                this.savePicks(this.picks, Alpine.store('betSlipConfig').minBet);
            },

            removePick(bettingLine, type) {
                if (!bettingLine || !type) {
                    console.error('Cannot remove pick: missing betting line or type', {
                        bettingLine,
                        type
                    });
                    return;
                }
                this.picks = this.picks.filter(p => !(p.betting_line === bettingLine && p.type === type));
                this.savePicks(this.picks, Alpine.store('betSlipConfig').minBet);
            },

            clearPicks() {
                this.picks = [];
                this.savePicks(this.picks, Alpine.store('betSlipConfig').minBet);
            }
        });

        // Register betSlip component
        Alpine.data('betSlip', (config) => ({
            isOpen: false,
            picks: [],
            amount: config.minBet || 0,
            submitted: false,

            init() {
                try {
                    this.picks = Alpine.store('betSlip').picks;
                    const storedSlip = JSON.parse(localStorage.getItem('betslip') || '{}');
                    this.amount = storedSlip.amount || config.minBet || 0;
                    window.addEventListener('betslip-updated', () => {
                        this.picks = Alpine.store('betSlip').picks;
                    });
                } catch (error) {
                    console.error('Bet slip init error:', error);
                }
            },

            toggle() {
                this.isOpen = !this.isOpen;
            },

            clearSlip() {
                Alpine.store('betSlip').clearPicks();
                this.picks = [];
                this.amount = config.minBet || 0;
            },

            removePick(index) {
                const pick = this.picks[index];
                if (pick) {
                    Alpine.store('betSlip').removePick(pick.betting_line, pick.type);
                }
            },

            calculateReturn() {
                const multiplier = Math.floor(config.baseBetStakes +
                    ((this.picks.length - config.minNumBets) / config.betStep) * config.betMultiplier);
                return Math.max(this.amount * multiplier, 0).toFixed(2);
            },

            saveAmount() {
                Alpine.store('betSlip').savePicks(this.picks, this.amount);
            },

            async submitBet() {
                if (this.amount < config.minBet || this.picks.length < config.minNumBets) {
                    Alpine.store('alerts').add({
                        message: 'Validation failed: Minimum bet or picks not met.',
                        type: 'danger'
                    });
                    return;
                }

                const payload = {
                    amount: this.amount,
                    picks: this.picks.map(pick => ({
                        betting_line: pick.betting_line,
                        pick_type: pick.type,
                        team: pick.team,
                        is_over: pick.is_over,
                        game: pick.game
                    }))
                };

                try {
                    const response = await fetch(config.submitUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': config.csrfToken
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        this.submitted = true;
                        Alpine.store('betSlip').clearPicks();
                        this.picks = [];
                        this.amount = config.minBet || 0;
                        Alpine.store('alerts').add({
                            message: 'Bet placed successfully!',
                            type: 'success'
                        });
                        setTimeout(() => {
                            this.submitted = false;
                            this.clearSlip();
                        }, 2000);
                    } else {
                        Alpine.store('alerts').add({
                            message: `Bet submission failed: ${result.error || 'Unknown error'}`,
                            type: 'danger'
                        });
                    }
                } catch (error) {
                    console.error('Error submitting bet:', error);
                    Alpine.store('alerts').add({
                        message: `Error submitting bet: ${error.message}`,
                        type: 'danger'
                    });
                }
            },

            displayPick(pick) {
                if (pick.type === 'sp') {
                    return `${pick.team || 'N/A'} Spread`;
                } else if (pick.type === 'uo') {
                    return pick.is_over ? 'Over' : 'Under';
                }
                return 'Unknown Pick';
            }
        }));
    });
</script>
