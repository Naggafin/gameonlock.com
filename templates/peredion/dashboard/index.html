{% extends 'base.html' %}
{% load static i18n django_tables2 humanize %}
{% block content %}
    <div class="dashboard-content"
         x-data="dashboard"
         x-init="init({ totalBets: {{ total_bets|default:0 }}, totalWins: {{ total_wins|default:0 }}, totalPayout: '{{ total_payout|default:0.00 }}', chartData: {{ chart|safe }} })">
        <div class="container">
            <div class="row">
                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                    <div class="dashboard-page">
                        <div class="dashboard-sidebar">
                            <button class="btn btn-primary sidebar-toggle-btn"
                                    type="button"
                                    data-bs-toggle="offcanvas"
                                    data-bs-target="#offcanvasExample"
                                    aria-controls="offcanvasExample"
                                    @click="sidebarOpen = !sidebarOpen">
                                <i class="fa-solid fa-bars"></i>
                            </button>
                            <div class="offcanvas offcanvas-start"
                                 tabindex="-1"
                                 id="offcanvasExample"
                                 aria-labelledby="offcanvasExampleLabel">
                                <div class="offcanvas-header">
                                    <a href="{% url 'home' %}" class="offcanvas-logo">
                                        <img src="{% static 'peredion/images/logo/mobile-logo.png' %}"
                                             alt=""
                                             nonce="{{ request.csp_nonce }}">
                                    </a>
                                    <button type="button"
                                            class="btn-offcanvas-reset text-reset"
                                            data-bs-dismiss="offcanvas"
                                            aria-label="Close">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                                <div class="offcanvas-body">
                                    <div class="mainmenu-9">
                                        <ul class="navbar-nav">
                                            <li class="nav-item">
                                                {% url 'dashboard' as url %}
                                                <a class="nav-link
                                                          {% if request.path == url %}active{% endif %}"
                                                   href="{{ url }}">
                                                    <i class="fa-solid fa-gauge fa-lg"></i>{% trans 'Dashboard' %}</a>
                                            </li>
                                            <li class="nav-item">
                                                {% url 'play_history' as url %}
                                                <a class="nav-link
                                                          {% if request.path == url %}active{% endif %}"
                                                   href="{{ url }}">
                                                    <i class="fa-solid fa-dice fa-lg"></i>{% trans 'bet history' %}</a>
                                            </li>
                                            <li class="nav-item">
                                                {% url 'transaction_history' as url %}
                                                <a class="nav-link
                                                          {% if request.path == url %}active{% endif %}"
                                                   href="{{ url }}">
                                                    <i class="fa-solid fa-arrow-right-arrow-left fa-lg"
                                                       style="font-size: 20px"></i>
                                                {% trans 'transaction history' %}</a>
                                            </li>
                                            <li class="nav-item">
                                                {% url 'settings' as url %}
                                                <a class="nav-link
                                                          {% if request.path == url %}active{% endif %}"
                                                   href="{{ url }}">
                                                    <i class="fa-solid fa-gear fa-lg"
                                                       style="--fa-primary-opacity: 0.4;
                                                              --fa-secondary-opacity: 1"></i>{% trans 'Settings' %}</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="dashboard-main-content">
                            <!-- Overview Section -->
                            <div class="row">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                    <div class="section-block"
                                         id="overview"
                                         data-aos="fade-up"
                                         data-aos-duration="500">
                                        <h3 class="section-heading">{% trans 'Overview' %}</h3>
                                        <div class="row dashboard-stats">
                                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6 col-12">
                                                <div class="card stat-card">
                                                    <div class="card-body">
                                                        <div class="stat-icon">
                                                            <i class="fa-solid fa-dice"></i>
                                                        </div>
                                                        <div class="stat-content">
                                                            <h6 class="card-title">{% trans 'Total Bets' %}</h6>
                                                            <p class="card-text" x-text="totalBets"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6 col-12">
                                                <div class="card stat-card">
                                                    <div class="card-body">
                                                        <div class="stat-icon">
                                                            <i class="fa-solid fa-trophy"></i>
                                                        </div>
                                                        <div class="stat-content">
                                                            <h6 class="card-title">{% trans 'Wins' %}</h6>
                                                            <p class="card-text" x-text="totalWins"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6 col-12">
                                                <div class="card stat-card">
                                                    <div class="card-body">
                                                        <div class="stat-icon">
                                                            <i class="fa-solid fa-money-bill-wave"></i>
                                                        </div>
                                                        <div class="stat-content">
                                                            <h6 class="card-title">{% trans 'Total Payout' %}</h6>
                                                            <p class="card-text" x-text="`$${totalPayout}`"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Chart -->
                                        <div class="card">
                                            <div class="card-body">
                                                <div id="chart"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Bet History Section -->
                            <div class="row">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                    <div class="section-block"
                                         id="bet-history"
                                         data-aos="fade-up"
                                         data-aos-duration="500">
                                        <h3 class="section-heading">{% trans 'Bet History' %}</h3>
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="table-responsive"
                                                     id="bet-history-table"
                                                     hx-get="{% url 'play_history' %}"
                                                     hx-trigger="load"
                                                     hx-swap="innerHTML">
                                                    <p>{% trans 'Loading bet history...' %}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Transaction History Section -->
                            <div class="row">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                    <div class="section-block"
                                         id="transaction-history"
                                         data-aos="fade-up"
                                         data-aos-duration="500">
                                        <h3 class="section-heading">{% trans 'Transaction History' %}</h3>
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="table-responsive"
                                                     id="transaction-history-table"
                                                     hx-get="{% url 'transaction_history' %}"
                                                     hx-trigger="load"
                                                     hx-swap="innerHTML">
                                                    <p>{% trans 'Loading transaction history...' %}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    {{ block.super }}
    <script src="{% static 'js/apexcharts.js' %}" nonce="{{ request.csp_nonce }}"></script>
    <script nonce="{{ request.csp_nonce }}">
        document.addEventListener('alpine:init', () => {
            Alpine.data('dashboard', () => ({
                sidebarOpen: false,
                totalBets: 0,
                totalWins: 0,
                totalPayout: '0.00',
                chartData: {
                    wins: [],
                    losses: [],
                    profit: []
                },
                init(data) {
                    this.totalBets = data.totalBets;
                    this.totalWins = data.totalWins;
                    this.totalPayout = data.totalPayout;
                    this.chartData = data.chartData;
                    this.renderChart();
                },
                renderChart() {
                    const options = {
                        chart: {
                            height: 276,
                            type: "area",
                            zoom: { enabled: false },
                            toolbar: { show: false },
                            fontFamily: 'Asap, Arial, sans-serif'
                        },
                        legend: { show: false },
                        grid: {
                            show: false,
                            padding: { top: 0, right: 0, bottom: 0, left: -10 }
                        },
                        dataLabels: {
                            enabled: false,
                            style: {
                                fontSize: '20px',
                                fontFamily: 'Asap, Arial, sans-serif',
                                fontWeight: 'bold'
                            }
                        },
                        series: [
                            { name: "Win", data: this.chartData.wins },
                            { name: "Loss", data: this.chartData.losses },
                            { name: "Profit", data: this.chartData.profit }
                        ],
                        fill: {
                            type: "gradient",
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.45,
                                opacityTo: 0.1,
                                stops: [0, 90, 100]
                            }
                        },
                        xaxis: {
                            categories: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                            labels: {
                                style: {
                                    colors: [],
                                    fontSize: '14px',
                                    fontFamily: 'Asap, Arial, sans-serif',
                                    fontWeight: 500
                                }
                            },
                            axisBorder: { show: false }
                        },
                        yaxis: {
                            min: 0,
                            max: Math.max(...this.chartData.wins, ...this.chartData.losses, ...this.chartData.profit, 1000),
                            tickAmount: 5,
                            labels: {
                                style: {
                                    colors: [],
                                    fontSize: '14px',
                                    fontFamily: 'Asap, Arial, sans-serif',
                                    fontWeight: 500
                                }
                            }
                        },
                        responsive: [{
                            breakpoint: 1400,
                            options: {
                                chart: { height: 256 },
                                legend: { position: "bottom" }
                            }
                        }]
                    };
                    const chart = new ApexCharts(document.querySelector("#chart"), options);
                    chart.render();
                }
            }));
        });
    </script>
{% endblock %}
