{% load static i18n %}
<div id="alerts"
     class="alerts-container"
     tabindex="0"
     x-data="alertsStore()"
     x-on:keydown.window.escape="dismissLast()">
    <template x-for="alert in alerts" :key="alert.id">
        <div x-show="alert.isVisible"
             @mouseenter="pause(alert)"
             @mouseleave="resume(alert)"
             @touchstart="pause(alert)"
             @touchend="resume(alert)"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-4"
             class="alert"
             :class="`alert-${alert.type}`"
             role="alert"
             data-aos="fade-up"
             data-aos-duration="500"
             data-aos-easing="ease-in">
            <div class="d-flex align-items-center">
                <div class="alert-icon me-2">
                    <i :class="{ 'fa-solid fa-circle-info': alert.type === 'info', 'fa-solid fa-check-circle': alert.type === 'success', 'fa-solid fa-exclamation-triangle': alert.type === 'warning', 'fa-solid fa-times-circle': alert.type === 'danger' }"></i>
                </div>
                <div class="alert-message" x-html="alert.message"></div>
            </div>
            <button type="button"
                    class="btn-close"
                    aria-label="{% trans 'Close' %}"
                    @click="dismiss(alert)"
                    :disabled="!alert.isVisible">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </template>
</div>
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('alpine:init', () => {
    Alpine.store('alertsState', {
        alerts: [],
        idCounter: 0,
        ready: false,

        add(message) {
            const id = ++this.idCounter;
            const alert = {
                ...message,
                id,
                isVisible: false,  // only show after ready
                timeout: message.timeout ?? 10000,
                isPaused: false,
                timer: null
            };

            this.alerts.push(alert);

            if (this.ready) {
                this.show(alert);
            }
        },

        show(alert) {
            alert.isVisible = true;
            this.startTimer(alert);
        },

        dismiss(alert) {
            alert.isVisible = false;
            clearTimeout(alert.timer);
            setTimeout(() => {
                this.alerts = this.alerts.filter(a => a.id !== alert.id);
            }, 300);
        },

        startTimer(alert) {
            if (alert.timeout > 0) {
                alert.timer = setTimeout(() => {
                    if (!alert.isPaused) this.dismiss(alert);
                }, alert.timeout);
            }
        },

        pause(alert) {
            alert.isPaused = true;
            clearTimeout(alert.timer);
        },

        resume(alert) {
            alert.isPaused = false;
            this.startTimer(alert);
        },

        markReady() {
            this.ready = true;
            this.alerts.forEach(alert => {
                if (!alert.isVisible) this.show(alert);
            });
        }
    });
});

function alertsStore() {
    return {
        get alerts() {
            return Alpine.store('alertsState').alerts;
        },
        dismiss(alert) {
            Alpine.store('alertsState').dismiss(alert);
        },
        dismissLast() {
            const visible = this.alerts.filter(a => a.isVisible);
            if (visible.length) {
                this.dismiss(visible[visible.length - 1]);
            }
        }
    }
}

window.addEventListener('PreloaderFinished', () => {
    Alpine.store('alertsState').markReady();
});

// SSE connection
const sse = new EventSource('/sse/notifications/');

sse.addEventListener('message', (event) => {
    const msg = JSON.parse(event.data);
    Alpine.store('alertsState').add(msg);
});
</script>
