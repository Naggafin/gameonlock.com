from django.db import migrations

def create_blog_index(apps, schema_editor):
    Page = apps.get_model("wagtailcore", "Page")
    BlogIndexPage = apps.get_model("blog", "BlogIndexPage")

    # Get root (homepage)
    root = Page.objects.get(depth=2)  # usually the site homepage
    if not BlogIndexPage.objects.filter(slug="blog").exists():
        blog_index = BlogIndexPage(
            title="Blog",
            slug="blog",
            depth=root.depth + 1,
            path=f"{root.path}0002",
        )
        root.add_child(instance=blog_index)
        blog_index.save_revision().publish()

class Migration(migrations.Migration):
    dependencies = [
        ("blog", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(create_blog_index),
    ]